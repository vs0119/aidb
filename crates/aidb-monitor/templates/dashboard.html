<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIDB Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .metric-card { 
            background: linear-gradient(145deg, #f3f4f6, #e5e7eb);
            box-shadow: 20px 20px 60px #d1d5db, -20px -20px 60px #ffffff;
        }
        .alert-critical { border-left: 4px solid #ef4444; }
        .alert-warning { border-left: 4px solid #f59e0b; }
        .alert-info { border-left: 4px solid #3b82f6; }
        .status-healthy { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-critical { color: #ef4444; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold text-gray-900">üîç AIDB Monitor</h1>
                    <span id="status-indicator" class="ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                        ‚óè ONLINE
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                        üîÑ Refresh
                    </button>
                    <select id="time-range" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Key Metrics Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Queries/sec</p>
                        <p id="qps" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="text-blue-600 text-2xl">‚ö°</div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <span id="qps-change" class="text-green-600">+0%</span> vs last hour
                </p>
            </div>

            <div class="metric-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Avg Latency</p>
                        <p id="avg-latency" class="text-3xl font-bold text-gray-900">0ms</p>
                    </div>
                    <div class="text-green-600 text-2xl">üöÄ</div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    P95: <span id="p95-latency">0ms</span>
                </p>
            </div>

            <div class="metric-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Error Rate</p>
                        <p id="error-rate" class="text-3xl font-bold text-gray-900">0%</p>
                    </div>
                    <div class="text-red-500 text-2xl">‚ö†Ô∏è</div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <span id="total-errors">0</span> total errors
                </p>
            </div>

            <div class="metric-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Memory</p>
                        <p id="memory-usage" class="text-3xl font-bold text-gray-900">0MB</p>
                    </div>
                    <div class="text-purple-600 text-2xl">üíæ</div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    CPU: <span id="cpu-usage">0%</span>
                </p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Query Performance</h3>
                <canvas id="latency-chart" width="400" height="200"></canvas>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">System Resources</h3>
                <canvas id="resources-chart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Alerts & Events Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Active Alerts -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Active Alerts</h3>
                    <span id="alert-count" class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">0</span>
                </div>
                <div id="alerts-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-gray-500 text-sm text-center py-8">No active alerts</div>
                </div>
            </div>

            <!-- Health Checks -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">System Health</h3>
                <div id="health-checks" class="space-y-3">
                    <div class="text-gray-500 text-sm text-center py-8">Loading health checks...</div>
                </div>
            </div>
        </div>

        <!-- Recent Events -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Recent Events</h3>
                <div class="flex items-center space-x-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="auto-refresh" checked class="mr-2">
                        <span class="text-sm text-gray-600">Auto-refresh</span>
                    </label>
                </div>
            </div>
            <div id="events-list" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-gray-500 text-sm text-center py-8">Loading events...</div>
            </div>
        </div>

        <!-- Collections Overview -->
        <div class="bg-white rounded-xl shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Collections Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-2xl font-bold text-blue-600" id="collections-count">0</p>
                    <p class="text-sm text-gray-600">Collections</p>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <p class="text-2xl font-bold text-green-600" id="vectors-count">0</p>
                    <p class="text-sm text-gray-600">Total Vectors</p>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <p class="text-2xl font-bold text-purple-600" id="connections-count">0</p>
                    <p class="text-sm text-gray-600">Active Connections</p>
                </div>
            </div>
        </div>

        <!-- Query Interface -->
        <div class="bg-white rounded-xl shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">AIDB Query Interface</h3>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button id="tab-collections" class="query-tab active border-b-2 border-blue-500 py-2 px-1 text-sm font-medium text-blue-600">
                        Collections
                    </button>
                    <button id="tab-search" class="query-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Vector Search
                    </button>
                    <button id="tab-insert" class="query-tab border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Insert Data
                    </button>
                </nav>
            </div>

            <!-- Collections Tab -->
            <div id="panel-collections" class="query-panel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Create Collection -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Create Collection</h4>
                        <form id="create-collection-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="collection-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Dimensions</label>
                                    <input type="number" id="collection-dim" value="768" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Metric</label>
                                    <select id="collection-metric" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="cosine">Cosine</option>
                                        <option value="euclidean">Euclidean</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Create Collection
                            </button>
                        </form>
                    </div>

                    <!-- Collections List -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-md font-medium text-gray-900">Existing Collections</h4>
                            <button onclick="loadCollections()" class="text-blue-600 hover:text-blue-800 text-sm">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div id="collections-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-gray-500 text-sm text-center py-4">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vector Search Tab -->
            <div id="panel-search" class="query-panel hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Search Form -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Vector Search</h4>
                        <form id="search-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Collection</label>
                                <select id="search-collection" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Select collection...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Query Vector (JSON array)</label>
                                <textarea id="search-vector" rows="3" placeholder="[0.1, 0.2, 0.3, ...]" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Top K</label>
                                <input type="number" id="search-k" value="10" min="1" max="100" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                                Search Vectors
                            </button>
                        </form>
                    </div>

                    <!-- Search Results -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Search Results</h4>
                        <div id="search-results" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-gray-500 text-sm text-center py-8">Run a search to see results</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insert Data Tab -->
            <div id="panel-insert" class="query-panel hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Insert Form -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Insert Vector</h4>
                        <form id="insert-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Collection</label>
                                <select id="insert-collection" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Select collection...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Vector (JSON array)</label>
                                <textarea id="insert-vector" rows="3" placeholder="[0.1, 0.2, 0.3, ...]" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Payload (JSON, optional)</label>
                                <textarea id="insert-payload" rows="3" placeholder='{"title": "example", "category": "test"}' class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                Insert Vector
                            </button>
                        </form>
                    </div>

                    <!-- Insert Results -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Operation Results</h4>
                        <div id="insert-results" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-gray-500 text-sm text-center py-8">Insert a vector to see results</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let latencyChart, resourcesChart;
        let refreshInterval;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
            
            // Set up auto-refresh
            const autoRefresh = document.getElementById('auto-refresh');
            if (autoRefresh.checked) {
                startAutoRefresh();
            }
            
            // Event listeners
            document.getElementById('refresh-btn').addEventListener('click', loadDashboardData);
            autoRefresh.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        });
        
        function initCharts() {
            // Latency Chart
            const latencyCtx = document.getElementById('latency-chart').getContext('2d');
            latencyChart = new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Avg Latency (ms)',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'QPS',
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Latency (ms)' } },
                        y1: { type: 'linear', display: true, position: 'right', 
                             title: { display: true, text: 'QPS' },
                             grid: { drawOnChartArea: false } }
                    }
                }
            });
            
            // Resources Chart
            const resourcesCtx = document.getElementById('resources-chart').getContext('2d');
            resourcesChart = new Chart(resourcesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU (%)',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Memory (MB)',
                        data: [],
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'CPU %' } },
                        y1: { type: 'linear', display: true, position: 'right',
                             title: { display: true, text: 'Memory (MB)' },
                             grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
        
        async function loadDashboardData() {
            try {
                // Load metrics
                const metricsResponse = await fetch('/api/metrics');
                const metrics = await metricsResponse.json();
                updateMetrics(metrics);
                
                // Load time series data
                const timeseriesResponse = await fetch('/api/metrics/timeseries?limit=100');
                const timeseries = await timeseriesResponse.json();
                updateCharts(timeseries);
                
                // Load health status
                const healthResponse = await fetch('/api/health');
                const health = await healthResponse.json();
                updateHealthChecks(health);
                
                // Load alerts
                const alertsResponse = await fetch('/api/alerts');
                const alerts = await alertsResponse.json();
                updateAlerts(alerts);
                
                // Load recent events
                const eventsResponse = await fetch('/api/events?limit=20');
                const events = await eventsResponse.json();
                updateEvents(events);
                
                // Update status indicator
                document.getElementById('status-indicator').className = 
                    'ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800';
                document.getElementById('status-indicator').textContent = '‚óè ONLINE';
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                document.getElementById('status-indicator').className = 
                    'ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800';
                document.getElementById('status-indicator').textContent = '‚óè ERROR';
            }
        }
        
        function updateMetrics(metrics) {
            document.getElementById('qps').textContent = metrics.qps.toFixed(1);
            document.getElementById('avg-latency').textContent = metrics.avg_query_latency_ms.toFixed(1) + 'ms';
            document.getElementById('p95-latency').textContent = metrics.p95_query_latency_ms.toFixed(1) + 'ms';
            
            const errorRate = metrics.query_count > 0 ? 
                (metrics.query_errors / metrics.query_count * 100) : 0;
            document.getElementById('error-rate').textContent = errorRate.toFixed(2) + '%';
            document.getElementById('total-errors').textContent = metrics.query_errors;
            
            document.getElementById('memory-usage').textContent = 
                (metrics.memory_usage_bytes / 1024 / 1024).toFixed(0) + 'MB';
            document.getElementById('cpu-usage').textContent = metrics.cpu_usage_percent.toFixed(1) + '%';
            
            document.getElementById('collections-count').textContent = metrics.collections_count;
            document.getElementById('vectors-count').textContent = metrics.total_vectors.toLocaleString();
            document.getElementById('connections-count').textContent = metrics.active_connections;
        }
        
        function updateCharts(timeseries) {
            // Format timestamps
            const labels = timeseries.timestamps.map(ts => 
                new Date(ts * 1000).toLocaleTimeString()
            );
            
            // Update latency chart
            latencyChart.data.labels = labels.slice(-50); // Last 50 points
            latencyChart.data.datasets[0].data = timeseries.query_latency.slice(-50);
            latencyChart.data.datasets[1].data = timeseries.qps.slice(-50);
            latencyChart.update('none');
            
            // Update resources chart
            resourcesChart.data.labels = labels.slice(-50);
            resourcesChart.data.datasets[0].data = timeseries.cpu_usage.slice(-50);
            resourcesChart.data.datasets[1].data = timeseries.memory_usage.slice(-50).map(m => m / 1024 / 1024);
            resourcesChart.update('none');
        }
        
        function updateHealthChecks(checks) {
            const container = document.getElementById('health-checks');
            container.innerHTML = '';
            
            checks.forEach(check => {
                const statusClass = check.status === 'Healthy' ? 'status-healthy' : 
                                  check.status === 'Warning' ? 'status-warning' : 'status-critical';
                
                const checkElement = document.createElement('div');
                checkElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                checkElement.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-900">${check.name}</div>
                        <div class="text-sm text-gray-600">${check.message}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold ${statusClass}">${check.status}</div>
                        <div class="text-xs text-gray-500">${check.check_duration_ms.toFixed(1)}ms</div>
                    </div>
                `;
                container.appendChild(checkElement);
            });
        }
        
        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-list');
            const countElement = document.getElementById('alert-count');
            
            countElement.textContent = alerts.length;
            countElement.className = alerts.length > 0 ? 
                'px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full pulse' :
                'px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-600 rounded-full';
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-8">No active alerts</div>';
                return;
            }
            
            container.innerHTML = '';
            alerts.forEach(alert => {
                const severityClass = alert.severity === 'Critical' ? 'alert-critical' :
                                    alert.severity === 'Warning' ? 'alert-warning' : 'alert-info';
                
                const alertElement = document.createElement('div');
                alertElement.className = `${severityClass} bg-white p-4 rounded-lg border-l-4 fade-in`;
                alertElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-gray-900">${alert.rule_id}</div>
                            <div class="text-sm text-gray-600">${alert.message}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                ${new Date(alert.triggered_at * 1000).toLocaleString()}
                            </div>
                        </div>
                        <button onclick="acknowledgeAlert('${alert.id}')" 
                                class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Acknowledge
                        </button>
                    </div>
                `;
                container.appendChild(alertElement);
            });
        }
        
        function updateEvents(events) {
            const container = document.getElementById('events-list');
            
            if (events.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-8">No recent events</div>';
                return;
            }
            
            container.innerHTML = '';
            events.forEach(event => {
                const severityColor = event.severity === 'Error' || event.severity === 'Critical' ? 'text-red-600' :
                                    event.severity === 'Warning' ? 'text-yellow-600' : 'text-gray-600';
                
                const eventElement = document.createElement('div');
                eventElement.className = 'flex items-center justify-between p-2 border-b border-gray-100';
                eventElement.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">${event.event_type}</span>
                            <span class="text-sm ${severityColor} font-medium">${event.severity}</span>
                        </div>
                        <div class="text-sm text-gray-900 mt-1">${event.message}</div>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${new Date(event.timestamp * 1000).toLocaleTimeString()}
                    </div>
                `;
                container.appendChild(eventElement);
            });
        }
        
        async function acknowledgeAlert(alertId) {
            try {
                await fetch(`/api/alerts/${alertId}/acknowledge`, { method: 'POST' });
                loadDashboardData(); // Refresh data
            } catch (error) {
                console.error('Failed to acknowledge alert:', error);
            }
        }
        
        function startAutoRefresh() {
            refreshInterval = setInterval(loadDashboardData, 5000); // 5 seconds
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Query Interface Functions
        
        // Tab Management
        document.addEventListener('DOMContentLoaded', function() {
            // Setup tab event listeners
            document.querySelectorAll('.query-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.id.replace('tab-', ''));
                });
            });

            // Setup form event listeners
            document.getElementById('create-collection-form').addEventListener('submit', handleCreateCollection);
            document.getElementById('search-form').addEventListener('submit', handleSearch);
            document.getElementById('insert-form').addEventListener('submit', handleInsert);

            // Load initial data
            loadCollections();
            populateCollectionSelects();
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.query-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');

            // Show/hide panels
            document.querySelectorAll('.query-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
        }

        // Collections Management
        async function loadCollections() {
            try {
                const response = await fetch('/api/aidb/collections');
                const collections = await response.json();
                
                displayCollections(collections);
                populateCollectionSelects(collections);
            } catch (error) {
                console.error('Failed to load collections:', error);
                document.getElementById('collections-list').innerHTML = 
                    '<div class="text-red-500 text-sm text-center py-4">Failed to load collections</div>';
            }
        }

        function displayCollections(collections) {
            const container = document.getElementById('collections-list');
            
            if (!collections || collections.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-4">No collections found</div>';
                return;
            }

            container.innerHTML = '';
            collections.forEach(collection => {
                const collectionElement = document.createElement('div');
                collectionElement.className = 'bg-white rounded-lg p-3 border border-gray-200';
                collectionElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-gray-900">${collection.name}</div>
                            <div class="text-sm text-gray-600">
                                ${collection.dim}D, ${collection.metric}, ${collection.len} vectors
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="compactCollection('${collection.name}')" 
                                    class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                Compact
                            </button>
                            <button onclick="snapshotCollection('${collection.name}')" 
                                    class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                Snapshot
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(collectionElement);
            });
        }

        function populateCollectionSelects(collections) {
            const searchSelect = document.getElementById('search-collection');
            const insertSelect = document.getElementById('insert-collection');
            
            // Clear existing options (except first one)
            [searchSelect, insertSelect].forEach(select => {
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
            });

            if (collections && collections.length > 0) {
                collections.forEach(collection => {
                    [searchSelect, insertSelect].forEach(select => {
                        const option = document.createElement('option');
                        option.value = collection.name;
                        option.textContent = `${collection.name} (${collection.dim}D)`;
                        select.appendChild(option);
                    });
                });
            }
        }

        // Form Handlers
        async function handleCreateCollection(event) {
            event.preventDefault();
            
            const name = document.getElementById('collection-name').value;
            const dim = parseInt(document.getElementById('collection-dim').value);
            const metric = document.getElementById('collection-metric').value;

            try {
                const response = await fetch('/api/aidb/collections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, dim, metric })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Collection '${name}' created successfully!`, 'success');
                    document.getElementById('create-collection-form').reset();
                    loadCollections();
                } else {
                    const error = await response.text();
                    showNotification(`Failed to create collection: ${error}`, 'error');
                }
            } catch (error) {
                console.error('Failed to create collection:', error);
                showNotification('Failed to create collection: Network error', 'error');
            }
        }

        async function handleSearch(event) {
            event.preventDefault();
            
            const collection = document.getElementById('search-collection').value;
            const vectorText = document.getElementById('search-vector').value;
            const topK = parseInt(document.getElementById('search-k').value);

            try {
                const vector = JSON.parse(vectorText);
                
                const response = await fetch(`/api/aidb/collections/${collection}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vector, top_k: topK })
                });

                if (response.ok) {
                    const result = await response.json();
                    displaySearchResults(result.results || []);
                } else {
                    const error = await response.text();
                    showNotification(`Search failed: ${error}`, 'error');
                }
            } catch (error) {
                console.error('Search failed:', error);
                if (error instanceof SyntaxError) {
                    showNotification('Invalid JSON format for vector', 'error');
                } else {
                    showNotification('Search failed: Network error', 'error');
                }
            }
        }

        async function handleInsert(event) {
            event.preventDefault();
            
            const collection = document.getElementById('insert-collection').value;
            const vectorText = document.getElementById('insert-vector').value;
            const payloadText = document.getElementById('insert-payload').value;

            try {
                const vector = JSON.parse(vectorText);
                let payload = null;
                
                if (payloadText.trim()) {
                    payload = JSON.parse(payloadText);
                }

                const response = await fetch(`/api/aidb/collections/${collection}/points`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vector, payload })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayInsertResult(result);
                    showNotification('Vector inserted successfully!', 'success');
                    loadCollections(); // Refresh collection info
                } else {
                    const error = await response.text();
                    showNotification(`Insert failed: ${error}`, 'error');
                }
            } catch (error) {
                console.error('Insert failed:', error);
                if (error instanceof SyntaxError) {
                    showNotification('Invalid JSON format', 'error');
                } else {
                    showNotification('Insert failed: Network error', 'error');
                }
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('search-results');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-8">No results found</div>';
                return;
            }

            container.innerHTML = '';
            results.forEach((result, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = 'bg-white rounded-lg p-3 border border-gray-200';
                resultElement.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-900">Result #${index + 1}</span>
                        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                            Score: ${result.score ? result.score.toFixed(4) : 'N/A'}
                        </span>
                    </div>
                    <div class="text-xs text-gray-600">
                        <div><strong>ID:</strong> ${result.id}</div>
                        ${result.payload ? `<div class="mt-1"><strong>Payload:</strong> ${JSON.stringify(result.payload)}</div>` : ''}
                    </div>
                `;
                container.appendChild(resultElement);
            });
        }

        function displayInsertResult(result) {
            const container = document.getElementById('insert-results');
            
            const resultElement = document.createElement('div');
            resultElement.className = 'bg-white rounded-lg p-3 border border-green-200';
            resultElement.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-green-600">‚úì</span>
                    <span class="text-sm font-medium text-gray-900">Vector Inserted</span>
                </div>
                <div class="text-xs text-gray-600">
                    <div><strong>ID:</strong> ${result}</div>
                    <div><strong>Time:</strong> ${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            // Add to top of results
            container.insertBefore(resultElement, container.firstChild);
            
            // Keep only last 10 results
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        async function compactCollection(name) {
            try {
                const response = await fetch(`/api/aidb/collections/${name}/compact`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showNotification(`Collection '${name}' compacted successfully!`, 'success');
                } else {
                    const error = await response.text();
                    showNotification(`Compact failed: ${error}`, 'error');
                }
            } catch (error) {
                showNotification('Compact failed: Network error', 'error');
            }
        }

        async function snapshotCollection(name) {
            try {
                const response = await fetch(`/api/aidb/collections/${name}/snapshot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    showNotification(`Snapshot of '${name}' created successfully!`, 'success');
                } else {
                    const error = await response.text();
                    showNotification(`Snapshot failed: ${error}`, 'error');
                }
            } catch (error) {
                showNotification('Snapshot failed: Network error', 'error');
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
    </script>
</body>
</html>